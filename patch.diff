From 16507c34ad98bee0872491c35bc64f5c36743373 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Manuel=20Eg=C3=ADo?= <manu@facine.es>
Date: Wed, 16 Nov 2022 09:23:10 +0100
Subject: [PATCH] Fix paragraph wrapper usage

---
 .../Menu/LocalTask/ParagraphWrapperUsage.php  | 28 +++++++++++++++++++
 .../unicef_paragraphs.links.task.yml          |  1 +
 .../unicef_paragraphs.module                  |  6 ++--
 3 files changed, 33 insertions(+), 2 deletions(-)
 create mode 100644 docroot/modules/custom/unicef_paragraphs/src/Plugin/Menu/LocalTask/ParagraphWrapperUsage.php

diff --git a/docroot/modules/custom/unicef_paragraphs/src/Plugin/Menu/LocalTask/ParagraphWrapperUsage.php b/docroot/modules/custom/unicef_paragraphs/src/Plugin/Menu/LocalTask/ParagraphWrapperUsage.php
new file mode 100644
index 000000000..2333afbfe
--- /dev/null
+++ b/docroot/modules/custom/unicef_paragraphs/src/Plugin/Menu/LocalTask/ParagraphWrapperUsage.php
@@ -0,0 +1,28 @@
+<?php
+
+namespace Drupal\unicef_paragraphs\Plugin\Menu\LocalTask;
+
+use Drupal\Core\Menu\LocalTaskDefault;
+use Drupal\Core\Routing\RouteMatchInterface;
+
+/**
+ * Provides a local task that shows the paragraph wrapper usage.
+ */
+class ParagraphWrapperUsage extends LocalTaskDefault {
+
+  /**
+   * {@inheritdoc}
+   */
+  public function getRouteParameters(RouteMatchInterface $route_match) {
+    $route_parameters = parent::getRouteParameters($route_match);
+
+    $parameters = $route_match->getParameters();
+    $paragraph_wrapper = $parameters->get('paragraph_wrapper');
+    if (!empty($paragraph_wrapper)) {
+      $route_parameters['paragraph_type'] = $paragraph_wrapper->bundle();
+    }
+
+    return $route_parameters;
+  }
+
+}
diff --git a/docroot/modules/custom/unicef_paragraphs/unicef_paragraphs.links.task.yml b/docroot/modules/custom/unicef_paragraphs/unicef_paragraphs.links.task.yml
index 3c7ba1782..539d5f59b 100644
--- a/docroot/modules/custom/unicef_paragraphs/unicef_paragraphs.links.task.yml
+++ b/docroot/modules/custom/unicef_paragraphs/unicef_paragraphs.links.task.yml
@@ -1,5 +1,6 @@
 unicef_paragraphs.paragraph_wrapper.usage:
   route_name: unicef_paragraphs.paragraph_wrapper.usage
   base_route: entity.paragraph_wrapper.canonical
+  class: Drupal\unicef_paragraphs\Plugin\Menu\LocalTask\ParagraphWrapperUsage
   title: Usage
   weight: 10
diff --git a/docroot/modules/custom/unicef_paragraphs/unicef_paragraphs.module b/docroot/modules/custom/unicef_paragraphs/unicef_paragraphs.module
index 41e098213..85116f410 100644
--- a/docroot/modules/custom/unicef_paragraphs/unicef_paragraphs.module
+++ b/docroot/modules/custom/unicef_paragraphs/unicef_paragraphs.module
@@ -85,8 +85,10 @@ function unicef_paragraphs_field_widget_inline_entity_form_complex_form_alter(&$
               'title' => t('Usage'),
               'url' => Url::fromRoute(
                 'unicef_paragraphs.paragraph_wrapper.usage',
-                ['paragraph_wrapper' => $element['entities'][$key]['#entity']->id()],
-                ['paragraph_type' => $element['entities'][$key]['#entity']->getType()],
+                [
+                  'paragraph_wrapper' => $element['entities'][$key]['#entity']->id(),
+                  'paragraph_type' => $element['entities'][$key]['#entity']->getType(),
+                ],
                 ['attributes' => ['target' => '_blank']]
               ),
             ],
-- 
2.31.0

